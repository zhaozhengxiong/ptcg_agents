
# 🧭 PTCG 多智能体系统 — 阶段任务验收标准

---

## **Phase 1：核心规则环境（Environment）**

**✅ 目标：**
能在纯 Python 环境下完成一局完整的模拟对战（通过命令行或脚本），并保证结果可复现。

| 任务            | 验收标准                                                                                                                            |
| ------------- | ------------------------------------------------------------------------------------------------------------------------------- |
| **项目初始化**     | - `pytest` 可运行，所有基础测试通过<br>- 日志可输出到文件并包含对战回合号与玩家名                                                                               |
| **对战状态机**     | - 可以按顺序执行 `Setup → TurnBegin → Draw → MainPhase → Attack → EndTurn → GameEnd`<br>- 不出现死循环或状态卡死<br>- `GameEnd` 能正确识别胜负条件         |
| **卡组与场景数据结构** | - 能从 JSON 文件加载一份卡组（如 60 张卡）<br>- 每张卡在对局中拥有唯一 ID (`card_uid`)<br>- 玩家初始状态（手牌、奖赏、牌堆、弃牌）符合规则                                       |
| **动作掩码系统**    | - `env.legal_actions()` 返回合法动作 JSON 列表<br>- 非法动作执行时返回 `ERR_ILLEGAL_ACTION`<br>- 合法动作执行后状态变化正确（例如 AttachEnergy 只在 MainPhase 可执行） |
| **奖励与胜负系统**   | - 对局结束时返回 `reward ∈ {-1, 1}`<br>- 击倒或获得奖赏触发中间奖励（如 +0.2）<br>- 测试脚本可统计胜率与平均奖励                                                     |
| **随机性与复现控制**  | - 同一 `seed` 和动作序列应生成完全相同结果<br>- 状态哈希一致（`env.hash_state()` 校验通过）                                                                 |
| **基础测试**      | - pytest 覆盖率 ≥ 70%<br>- 至少有 3 个完整回合的自动测试脚本成功运行                                                                                  |

---

## **Phase 2：IR / DSL 规则引擎**

**✅ 目标：**
能从 IR JSON 定义解析并执行 10–20 张基础卡的效果（Draw, Search, AttachEnergy 等）。

| 任务               | 验收标准                                                                           |
| ---------------- | ------------------------------------------------------------------------------ |
| **IR Schema 设计** | - IR JSON 文件可通过 JSON Schema 校验<br>- Schema 支持 Trigger / Effect / Modifier 三种类型 |
| **原子效果函数库**      | - 每种效果（如 Draw、AddDamage、Discard）有单元测试<br>- 执行后能正确修改状态并返回操作日志                   |
| **IR 执行引擎**      | - 执行一个完整的 `EffectSequence`，能递归执行子效果<br>- 支持 OncePerTurn 限制、条件判断、Gate 嵌套        |
| **规则验证与异常处理**    | - 非法字段或参数类型报错<br>- 触发条件不符时不会执行效果<br>- 异常均有捕获并返回标准错误码                           |
| **IR 数据加载与缓存**   | - 能从数据库或 JSON 载入 IR 数据<br>- 规则版本 hash 一致性校验通过                                  |
| **单元测试自动化模板**    | - 每张卡自动生成 ≥3 个单测（正常、非法、边界）<br>- 运行后全部通过（pass ≥ 90%）                            |

---

## **Phase 3：API 化与服务化**

**✅ 目标：**
Python 对战环境能通过 NestJS 提供 REST / gRPC 接口访问，并具备日志与回放能力。

| 任务              | 验收标准                                                                                               |
| --------------- | -------------------------------------------------------------------------------------------------- |
| **NestJS 初始化**  | - 服务能在 3000 端口启动并返回 `/healthz: ok`<br>- 数据库连接成功（PostgreSQL）                                        |
| **Python 接口封装** | - `/env/create` 可创建对局并返回 `env_id`<br>- `/env/step` 可推进对局并返回新状态<br>- `/env/legal_actions` 返回当前可执行动作 |
| **Replay 机制**   | - 可导出 `.replay.json` 文件（含 seed、动作序列）<br>- 可通过 `/replay/load` 重播对局，结果一致                             |
| **日志与错误追踪**     | - 每次请求写入操作日志（含 player_id, action, timestamp）<br>- 异常请求返回标准化错误 JSON（含 error_code 与 message）         |

---

## **Phase 4：Player Agent**

**✅ 目标：**
具备可运行的智能体，可与自己或随机对手对战并产生学习曲线（Elo / reward）。

| 任务                            | 验收标准                                                          |
| ----------------------------- | ------------------------------------------------------------- |
| **Action Schema**             | - 所有动作符合 JSON Schema 定义<br>- 由 Agent 输出的动作能直接被 `/env/step` 执行 |
| **随机 / 脚本型 Bot**              | - RandomAgent 完成 100 场对局不报错<br>- RuleBasedAgent 胜率 ≥ 随机代理 60% |
| **强化学习 Agent（PPO / IS-MCTS）** | - 训练过程中 Reward 有明显上升趋势<br>- 模型可保存/加载（checkpoint）              |
| **对手池机制**                     | - 训练过程中随机抽取旧模型参与对战<br>- Elo 曲线随时间更新（持久化记录）                    |
| **自博弈训练管线**                   | - 多线程模拟速率 ≥ 500 step/s<br>- 日志显示每局 reward、胜率、时长等指标            |

---

## **Phase 5：前端可视化**

**✅ 目标：**
实现对战回放、训练曲线可视化、卡牌浏览等功能。

| 任务         | 验收标准                                                              |
| ---------- | ----------------------------------------------------------------- |
| **项目初始化**  | - 前端可独立启动（`npm run dev`）<br>- 可访问首页仪表盘页面                          |
| **对局回放页面** | - 从 `/replay/load` 获取数据并逐步回放<br>- 可暂停 / 单步播放 / 跳转回合<br>- 动画同步玩家动作 |
| **训练可视化**  | - Elo 曲线与平均 Reward 实时更新<br>- 支持选择训练阶段过滤                           |
| **卡牌浏览器**  | - 可展示卡面图片、效果文本、IR JSON<br>- 搜索过滤可用系列与类型                           |

---

## **Phase 6：自动规则编译器**

**✅ 目标：**
能自动将卡牌文本解析为 IR 并生成单元测试，人工确认后入库。

| 任务            | 验收标准                                                                                                    |
| ------------- | ------------------------------------------------------------------------------------------------------- |
| **规则解析模板**    | - LLM 模板能从卡牌原文正确提取触发条件与效果槽位<br>- 解析成功率 ≥ 80%                                                            |
| **IR 生成与验证**  | - 自动生成的 IR 通过 Schema 校验<br>- 自动生成的单测全部通过（≥90%）                                                          |
| **人工审阅与版本冻结** | - 每次规则修改生成唯一版本 hash<br>- 审阅后入库 PostgreSQL，并冻结不可修改                                                       |
| **流水线集成**     | - 命令 `python compiler_pipeline.py` 可一键执行整个流程<br>- 输出文件夹包含：`ir.json`, `unit_test.py`, `version_hash.txt` |

---

# ✅ 整体验收标准（系统级）

| 类别        | 验收指标                      |
| --------- | ------------------------- |
| **功能完整性** | 各阶段模块均可独立运行并通过集成测试        |
| **复现性**   | 相同输入（seed + 动作）必得相同输出     |
| **性能**    | 批量模拟速率 ≥ 500 step/s       |
| **可扩展性**  | 新增卡牌仅需导入 IR 数据即可运行        |
| **测试覆盖**  | 单元测试 ≥ 80%，集成测试 ≥ 3 套完整对局 |
| **稳定性**   | 连续 1000 场自博弈无异常退出         |

---

